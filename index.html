<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Visa Manager">
<meta name="theme-color" content="#c9a84c">
<meta name="description" content="Qu·∫£n l√Ω h·ªì s∆° xin visa Ch√¢u √Çu">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<title>Visa Manager ‚Äì H·ªì S∆° Ch√¢u √Çu</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Tesseract.js/4.1.1/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.2.3/build/index.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;font-size:14px;background:linear-gradient(135deg,#f5f7fa,#e8eaf0,#dfe3eb);color:#1a2332;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 15%,rgba(201,168,76,.12) 0%,transparent 40%),radial-gradient(ellipse at 80% 85%,rgba(100,140,200,.08) 0%,transparent 45%);pointer-events:none;z-index:0}
.app{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:0 14px 80px}

/* HEADER */
.hdr{text-align:center;padding:32px 20px 20px}
.hdr::after{content:'';display:block;width:80px;height:2px;background:linear-gradient(90deg,transparent,#c9a84c,transparent);margin:16px auto 0}
.badge{display:inline-block;background:rgba(201,168,76,.2);border:1px solid rgba(201,168,76,.4);color:#8b7234;font-size:11px;letter-spacing:2px;text-transform:uppercase;padding:4px 16px;border-radius:40px;margin-bottom:12px;font-weight:700}
.hdr h1{font-size:clamp(20px,5vw,36px);font-weight:700;color:#1a2332;line-height:1.3}
.hdr h1 span{color:#c9a84c}
.hdr p{color:#5a6b7f;font-size:13px;margin-top:6px}

/* LANG BAR */
.lang-bar{display:flex;justify-content:center;gap:8px;margin:0 0 18px}
.lang-btn{display:flex;align-items:center;gap:6px;padding:9px 20px;border-radius:40px;border:1.5px solid rgba(201,168,76,.4);background:#fff;color:#5a6b7f;font-size:13px;cursor:pointer;transition:all .2s;font-weight:600}
.lang-btn.active,.lang-btn:hover{background:#c9a84c;border-color:#c9a84c;color:#fff;box-shadow:0 4px 12px rgba(201,168,76,.3)}

/* CARD */
.card{background:#fff;border:1px solid rgba(201,168,76,.22);border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 4px 16px rgba(0,0,0,.07);animation:fadeUp .3s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.sec-title{font-size:15px;font-weight:700;color:#8b7234;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.sec-title::before{content:'';width:4px;height:18px;background:#c9a84c;border-radius:2px;flex-shrink:0}

/* TABS */
.tabs{display:flex;gap:4px;margin-bottom:16px;background:#f0f2f5;padding:4px;border-radius:8px}
.tab-btn{flex:1;padding:9px 6px;border:none;background:transparent;color:#5a6b7f;font-size:12px;font-weight:700;border-radius:6px;cursor:pointer;transition:all .2s;font-family:Arial,sans-serif}
.tab-btn.active{background:#fff;color:#c9a84c;box-shadow:0 2px 6px rgba(0,0,0,.08)}

/* AI TOOLS */
.ai-tools{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
@media(max-width:480px){.ai-tools{grid-template-columns:1fr}}
.ai-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;border-radius:8px;border:1.5px solid rgba(201,168,76,.35);background:rgba(201,168,76,.07);color:#1a2332;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;font-family:Arial,sans-serif}
.ai-btn:hover{border-color:#c9a84c;background:rgba(201,168,76,.14)}
.ai-btn.recording{border-color:#e74c3c;background:rgba(231,76,60,.1);color:#c0392b;animation:pulse 1.4s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,.3)}50%{box-shadow:0 0 0 8px rgba(231,76,60,0)}}
.ai-btn .icon{font-size:18px}

/* STATUS */
.status{background:#f8f9fa;border:1px solid #dce0e5;border-radius:8px;padding:10px 13px;font-size:13px;color:#5a6b7f;min-height:40px;display:flex;align-items:center;gap:8px;margin-bottom:12px;transition:all .2s}
.status.ok{color:#2e7d32;background:#f1f8f4;border-color:#a5d6a7}
.status.err{color:#c62828;background:#ffebee;border-color:#ef9a9a}
.status.run{color:#8b7234;background:#fff9e6;border-color:#ffe082}
.spin{width:14px;height:14px;border:2px solid rgba(201,168,76,.3);border-top-color:#c9a84c;border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

/* VOICE WAVE */
.vwave{display:none;align-items:center;justify-content:center;gap:3px;height:26px;margin-bottom:10px}
.vwave.on{display:flex}
.vwave span{width:4px;background:#c9a84c;border-radius:2px;animation:wave .9s ease infinite}
.vwave span:nth-child(1){animation-delay:0s}.vwave span:nth-child(2){animation-delay:.1s}
.vwave span:nth-child(3){animation-delay:.2s}.vwave span:nth-child(4){animation-delay:.3s}
.vwave span:nth-child(5){animation-delay:.4s}
@keyframes wave{0%,100%{height:5px}50%{height:20px}}

/* FORM */
.fg{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.fgrp{display:flex;flex-direction:column;gap:5px}
.fgrp.fw{grid-column:1/-1}
label{font-size:11px;font-weight:700;letter-spacing:.4px;color:#8b7234;text-transform:uppercase}
label .req{color:#e74c3c;margin-left:2px}
input,select,textarea{background:#fff;border:1.5px solid #d0d5dd;border-radius:7px;padding:10px 12px;color:#1a2332;font-family:Arial,sans-serif;font-size:14px;transition:all .18s;outline:none;width:100%;-webkit-appearance:none}
input:focus,select:focus,textarea:focus{border-color:#c9a84c;background:#fffbf0;box-shadow:0 0 0 3px rgba(201,168,76,.13)}
input::placeholder,textarea::placeholder{color:#a0aec0}
.input-err{border-color:#e74c3c!important;background:#fff5f5!important}
.err-msg{font-size:11px;color:#c62828}

/* UPLOAD ZONE */
.upzone{border:2px dashed #c9a84c;border-radius:10px;padding:22px;text-align:center;cursor:pointer;transition:all .22s;background:#fffbf0;user-select:none}
.upzone:hover,.upzone:active{border-color:#8b7234;background:#fff9e6}
.upzone .ui{font-size:32px;margin-bottom:8px}
.upzone p{font-size:13px;color:#5a6b7f}
#ocrImg{max-width:100%;max-height:180px;object-fit:contain;border-radius:7px;margin-top:10px;display:none;border:1px solid #dce0e5}
.prog-bar{height:5px;background:#f0f2f5;border-radius:3px;overflow:hidden;margin-top:8px;display:none}
.prog-fill{height:100%;background:linear-gradient(90deg,#c9a84c,#d4b55e);border-radius:3px;transition:width .3s;width:0}

/* CAMERA BUTTON */
.cam-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media(max-width:400px){.cam-row{grid-template-columns:1fr}}
.cam-btn{display:flex;align-items:center;justify-content:center;gap:7px;padding:13px;border-radius:8px;border:1.5px solid rgba(201,168,76,.35);background:rgba(201,168,76,.07);color:#1a2332;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;font-family:Arial,sans-serif}
.cam-btn:hover{border-color:#c9a84c;background:rgba(201,168,76,.14)}

/* TELEX HINT */
.telex-hint{background:#fff9e6;border:1px dashed #ffe082;border-radius:7px;padding:11px 14px;margin-bottom:12px;font-size:12px;color:#5a6b7f;line-height:1.7}
.telex-hint strong{color:#8b7234}
.telex-hint code{background:#fffbf0;padding:1px 5px;border-radius:3px;color:#8b7234;border:1px solid #ffe082}

/* BUTTONS */
.btn-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:20px;justify-content:flex-end}
.btn{padding:11px 24px;border-radius:40px;border:none;font-family:Arial,sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
.btn-p{background:linear-gradient(135deg,#c9a84c,#d4b55e);color:#fff;box-shadow:0 2px 8px rgba(201,168,76,.3)}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(201,168,76,.4)}
.btn-s{background:#fff;border:1.5px solid #d0d5dd;color:#1a2332}
.btn-s:hover{border-color:#c9a84c;color:#8b7234;background:#fffbf0}
.btn-d{background:#fff;border:1px solid #ef9a9a;color:#c62828;padding:6px 12px;font-size:12px}
.btn-d:hover{background:#ffebee}

/* TABLE */
.sum-bar{display:flex;align-items:center;justify-content:space-between;background:#f8f9fa;border:1px solid #dce0e5;border-radius:8px;padding:10px 16px;margin-bottom:12px;flex-wrap:wrap;gap:8px;font-size:14px}
.cnt{background:#c9a84c;color:#fff;font-weight:700;font-size:13px;padding:2px 10px;border-radius:20px}
.tbl-wrap{overflow:auto;border-radius:8px;border:1px solid #dce0e5;max-height:380px;background:#fff}
.ptbl{width:100%;border-collapse:collapse;font-size:13px;white-space:nowrap}
.ptbl thead{background:#f8f9fa;position:sticky;top:0;z-index:2}
.ptbl th{padding:10px 12px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;color:#8b7234;border-bottom:2px solid #c9a84c}
.ptbl td{padding:8px 12px;border-bottom:1px solid #f0f2f5;color:#1a2332}
.ptbl tbody tr:hover{background:#fffbf0}
.empty{text-align:center;padding:40px 20px;color:#a0aec0}
.empty .ei{font-size:40px;margin-bottom:10px;opacity:.35}

/* EXPORT */
.exp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
.exp-card{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 12px;border-radius:8px;border:1px solid #dce0e5;background:#fff;cursor:pointer;transition:all .2s}
.exp-card:hover{border-color:#c9a84c;background:#fffbf0;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.exp-card .ei{font-size:28px}
.exp-card .el{font-size:13px;font-weight:700;color:#1a2332}
.exp-card .es{font-size:11px;color:#5a6b7f}

/* TOAST */
.toast-wrap{position:fixed;bottom:20px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:#fff;border-left:4px solid #c9a84c;border-radius:7px;padding:12px 14px;font-size:13px;color:#1a2332;box-shadow:0 4px 16px rgba(0,0,0,.14);animation:slideIn .25s ease;max-width:300px;border:1px solid #dce0e5}
.toast.err{border-left-color:#e74c3c;background:#fff5f5}
.toast.ok{border-left-color:#4caf50;background:#f1f8f4}
@keyframes slideIn{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}

/* GUIDE */
.guide{background:#fff9e6;border:1px solid #ffe082;border-radius:8px;padding:12px 16px;font-size:13px;color:#5a6b7f;line-height:1.75}
.guide strong{color:#8b7234}

/* MIC PERMISSION NOTE */
.mic-note{background:#e8f4fd;border:1px solid #90caf9;border-radius:8px;padding:10px 14px;font-size:12px;color:#1565c0;margin-bottom:12px;display:none}
.mic-note.show{display:block}

/* SAFE AREA (iPhone notch) */
.app{padding-bottom:calc(80px + env(safe-area-inset-bottom))}

@media(max-width:600px){
  .fg{grid-template-columns:1fr 1fr}
  .exp-grid{grid-template-columns:1fr 1fr}
}
@media(max-width:380px){
  .fg{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<div class="hdr">
  <div class="badge">üõÇ Visa Management System</div>
  <h1>Qu·∫£n L√Ω<br><span>H·ªì S∆° Visa Ch√¢u √Çu</span></h1>
  <p>OCR ·∫£nh h·ªô chi·∫øu ¬∑ Ghi √¢m AI ¬∑ Xu·∫•t Excel / Word / PDF</p>
</div>

<!-- LANG TOGGLE -->
<div class="lang-bar">
  <button class="lang-btn active" id="langVI" onclick="setLang('vi')">üáªüá≥ Ti·∫øng Vi·ªát</button>
  <button class="lang-btn" id="langEN" onclick="setLang('en')">üá∫üá∏ English Output</button>
</div>

<!-- GUIDE -->
<div class="card" style="padding:14px 18px">
  <div class="guide">
    <strong>üìã H∆∞·ªõng d·∫´n:</strong>
    (1) D√πng <strong>Ghi √¢m</strong> ho·∫∑c <strong>OCR ·∫£nh</strong> ƒë·ªÉ nh·∫≠p nhanh, ho·∫∑c ƒëi·ªÅn <strong>Th·ªß c√¥ng</strong>.
    (2) Nh·∫•n <strong>Th√™m v√†o danh s√°ch</strong> ƒë·ªÉ l∆∞u.
    (3) Ch·ªçn ng√¥n ng·ªØ xu·∫•t ‚Üí Nh·∫•n <strong>Excel / Word / PDF</strong>.
  </div>
</div>

<!-- AI INPUT CARD -->
<div class="card">
  <div class="sec-title">ü§ñ Nh·∫≠p li·ªáu AI</div>
  <div class="tabs">
    <button class="tab-btn active" onclick="swTab('voice',this)">üé§ Ghi √¢m</button>
    <button class="tab-btn" onclick="swTab('ocr',this)">üì∑ OCR ·∫¢nh</button>
    <button class="tab-btn" onclick="swTab('manual',this)">‚úèÔ∏è Th·ªß c√¥ng</button>
  </div>

  <!-- TAB: VOICE -->
  <div id="tab-voice" class="tc active">
    <div id="micNote" class="mic-note">
      ‚ÑπÔ∏è <strong>Cho ph√©p Microphone:</strong> Khi h·ªèi quy·ªÅn ‚Üí nh·∫•n <strong>Cho ph√©p / Allow</strong>.
      N·∫øu ƒë√£ t·ª´ ch·ªëi: v√†o <strong>Settings tr√¨nh duy·ªát ‚Üí Quy·ªÅn trang web ‚Üí Microphone</strong> ‚Üí b·∫≠t l·∫°i.
    </div>
    <div class="ai-tools">
      <button class="ai-btn" id="vBtn" onclick="togVoice()">
        <span class="icon">üé§</span><span id="vBtnTxt">B·∫Øt ƒë·∫ßu ghi √¢m</span>
      </button>
      <button class="ai-btn" onclick="parseVoice()">
        <span class="icon">‚ö°</span><span>Ph√¢n t√≠ch ‚Üí ƒêi·ªÅn form</span>
      </button>
    </div>
    <div class="vwave" id="vwave"><span></span><span></span><span></span><span></span><span></span></div>
    <div class="status" id="vStatus">üí¨ Nh·∫•n "B·∫Øt ƒë·∫ßu ghi √¢m" r·ªìi n√≥i th√¥ng tin b·∫±ng ti·∫øng Vi·ªát...</div>
    <label style="margin-top:8px;display:block">VƒÉn b·∫£n ghi √¢m / Nh·∫≠p th·ªß c√¥ng ƒë·ªÉ AI ph√¢n t√≠ch:</label>
    <textarea id="vText" rows="4" style="margin-top:6px;resize:vertical"
      placeholder="VD: Ho ten Nguyen Van An, sinh ngay 15 thang 3 nam 1990, que Ha Noi, nam gioi, CCCD 001090012345..."></textarea>
  </div>

  <!-- TAB: OCR -->
  <div id="tab-ocr" class="tc">
    <!-- N√∫t ch·ª•p / ch·ªçn ·∫£nh t√°ch bi·ªát nhau -->
    <div class="cam-row">
      <button class="cam-btn" onclick="openCamera()">
        <span style="font-size:20px">üì∏</span> Ch·ª•p ·∫£nh
      </button>
      <button class="cam-btn" onclick="openGallery()">
        <span style="font-size:20px">üñºÔ∏è</span> Ch·ªçn t·ª´ m√°y
      </button>
    </div>
    <!-- Hidden inputs: camera vs gallery ri√™ng ƒë·ªÉ tr√°nh l·ªói -->
    <input type="file" id="ocrCamera"  accept="image/*" capture="environment" style="display:none" onchange="handleOCRFile(this.files[0])">
    <input type="file" id="ocrGallery" accept="image/*" style="display:none"             onchange="handleOCRFile(this.files[0])">

    <img id="ocrImg" alt="Preview ·∫£nh">
    <div class="prog-bar" id="ocrBar"><div class="prog-fill" id="ocrFill"></div></div>
    <div class="status" id="ocrStatus">üì∏ Ch·ª•p ·∫£nh ho·∫∑c ch·ªçn t·ª´ m√°y ƒë·ªÉ nh·∫≠n di·ªán t·ª± ƒë·ªông...</div>
  </div>

  <!-- TAB: MANUAL -->
  <div id="tab-manual" class="tc">
    <div class="telex-hint">
      <strong>‚ö° B·ªô g√µ Telex t√≠ch h·ª£p s·∫µn:</strong><br>
      <code>aa</code>‚Üí√¢ &nbsp; <code>aw</code>‚ÜíƒÉ &nbsp; <code>ee</code>‚Üí√™ &nbsp; <code>oo</code>‚Üí√¥ &nbsp; <code>ow</code>‚Üí∆° &nbsp; <code>uw</code>/<code>w</code>‚Üí∆∞ &nbsp; <code>dd</code>‚Üíƒë<br>
      <code>s</code>‚Üís·∫Øc &nbsp; <code>f</code>‚Üíhuy·ªÅn &nbsp; <code>r</code>‚Üíh·ªèi &nbsp; <code>x</code>‚Üíng√£ &nbsp; <code>j</code>‚Üín·∫∑ng
    </div>
    <p style="font-size:13px;color:#718096">T·∫•t c·∫£ √¥ nh·∫≠p b√™n d∆∞·ªõi ƒë·ªÅu h·ªó tr·ª£ g√µ Telex ti·∫øng Vi·ªát.</p>
  </div>
</div>

<!-- MAIN FORM -->
<div class="card">
  <div class="sec-title">üìù Th√¥ng tin h·ªì s∆°</div>
  <form id="mainForm" onsubmit="return false">
    <div class="fg">
      <div class="fgrp fw">
        <label>H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß <span class="req">*</span></label>
        <input type="text" id="fullName" placeholder="VD: Nguyen Van An">
        <div class="err-msg" id="e-fullName"></div>
      </div>
      <div class="fgrp">
        <label>H·ªç (t·ª± t√°ch)</label>
        <input type="text" id="ho" placeholder="Nguyen" style="background:rgba(201,168,76,.04)">
      </div>
      <div class="fgrp">
        <label>T√™n (t·ª± t√°ch)</label>
        <input type="text" id="ten" placeholder="Van An" style="background:rgba(201,168,76,.04)">
      </div>
      <div class="fgrp">
        <label>Ng√†y th√°ng nƒÉm sinh <span class="req">*</span></label>
        <input type="date" id="ngaySinh">
      </div>
      <div class="fgrp">
        <label>N∆°i sinh</label>
        <input type="text" id="noiSinh" placeholder="VD: Ha Noi">
      </div>
      <div class="fgrp">
        <label>N∆∞·ªõc sinh</label>
        <input type="text" id="nuocSinh" value="Vi·ªát Nam">
      </div>
      <div class="fgrp">
        <label>Gi·ªõi t√≠nh <span class="req">*</span></label>
        <select id="gioiTinh">
          <option value="">-- Ch·ªçn --</option>
          <option value="Nam">Nam</option>
          <option value="N·ªØ">N·ªØ</option>
          <option value="Kh√°c">Kh√°c</option>
        </select>
      </div>
      <div class="fgrp">
        <label>T√¨nh tr·∫°ng h√¥n nh√¢n</label>
        <select id="honNhan">
          <option value="">-- Ch·ªçn --</option>
          <option value="ƒê·ªôc th√¢n">ƒê·ªôc th√¢n</option>
          <option value="ƒê√£ k·∫øt h√¥n">ƒê√£ k·∫øt h√¥n</option>
          <option value="Ly h√¥n">Ly h√¥n</option>
          <option value="G√≥a">G√≥a</option>
        </select>
      </div>
      <div class="fgrp">
        <label>CCCD / ID <span class="req">*</span></label>
        <input type="text" id="cccd" placeholder="9 ho·∫∑c 12 s·ªë" maxlength="12" inputmode="numeric" oninput="valCCCD(this)">
        <div class="err-msg" id="e-cccd"></div>
      </div>
      <div class="fgrp">
        <label>S·ªë h·ªô chi·∫øu</label>
        <input type="text" id="hoChieu" placeholder="VD: B1234567" oninput="valPassport(this)">
        <div class="err-msg" id="e-hoChieu"></div>
      </div>
      <div class="fgrp">
        <label>Ng√†y c·∫•p h·ªô chi·∫øu</label>
        <input type="date" id="ngayCap">
      </div>
      <div class="fgrp">
        <label>Ng√†y h·∫øt h·∫°n h·ªô chi·∫øu</label>
        <input type="date" id="ngayHetHan">
      </div>
      <div class="fgrp fw">
        <label>ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫</label>
        <input type="text" id="diaChi" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë">
      </div>
      <div class="fgrp">
        <label>Email</label>
        <input type="email" id="email" placeholder="example@email.com" inputmode="email" oninput="valEmail(this)">
        <div class="err-msg" id="e-email"></div>
      </div>
      <div class="fgrp">
        <label>ƒêi·ªán tho·∫°i</label>
        <input type="tel" id="dienThoai" placeholder="0912345678" inputmode="tel">
      </div>
      <div class="fgrp">
        <label>Ch·ª©c v·ª•</label>
        <input type="text" id="chucVu" placeholder="VD: Ky su phan mem">
      </div>
      <div class="fgrp">
        <label>T√™n c√¥ng ty</label>
        <input type="text" id="tenCty" placeholder="VD: Cong ty TNHH ABC">
      </div>
      <div class="fgrp">
        <label>ƒêi·ªán tho·∫°i c√¥ng ty</label>
        <input type="tel" id="dtCty" placeholder="028xxxxxxxx" inputmode="tel">
      </div>
      <div class="fgrp fw">
        <label>ƒê·ªãa ch·ªâ c√¥ng ty</label>
        <input type="text" id="dcCty" placeholder="ƒê·ªãa ch·ªâ vƒÉn ph√≤ng / c√¥ng ty">
      </div>
      <div class="fgrp">
        <label>ƒê√£ t·ª´ng ƒëi ch√¢u √Çu?</label>
        <select id="didiCA">
          <option value="Ch∆∞a">Ch∆∞a</option>
          <option value="R·ªìi">R·ªìi</option>
        </select>
      </div>
      <div class="fgrp">
        <label>Ng√†y c·∫•p visa</label>
        <input type="date" id="ngayCapVisa">
      </div>
      <div class="fgrp">
        <label>Ng√†y h·∫øt h·∫°n visa</label>
        <input type="date" id="ngayHHVisa">
      </div>
      <div class="fgrp">
        <label>Ng∆∞·ªùi chi tr·∫£</label>
        <input type="text" id="nguoiCT" placeholder="T√™n ng∆∞·ªùi chi tr·∫£">
      </div>
      <div class="fgrp">
        <label>Ng∆∞·ªùi b·∫£o tr·ª£</label>
        <input type="text" id="nguoiBT" placeholder="T√™n ng∆∞·ªùi b·∫£o l√£nh">
      </div>
    </div>
    <div class="btn-row">
      <button type="button" class="btn btn-s" onclick="clrForm()">üóëÔ∏è X√≥a form</button>
      <button type="button" class="btn btn-p" onclick="addPerson()">Ôºã Th√™m v√†o danh s√°ch</button>
    </div>
  </form>
</div>

<!-- PREVIEW LIST -->
<div class="card">
  <div class="sec-title">üìã Danh s√°ch h·ªì s∆°</div>
  <div class="sum-bar">
    <div style="display:flex;align-items:center;gap:8px">T·ªïng: <span class="cnt" id="totCnt">0</span> h·ªì s∆°</div>
    <button class="btn btn-s" onclick="clrAll()" style="padding:7px 13px;font-size:12px">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
  </div>
  <div class="tbl-wrap" id="tblWrap">
    <div class="empty"><div class="ei">üìÇ</div><p>Ch∆∞a c√≥ h·ªì s∆°. H√£y th√™m ng∆∞·ªùi ƒë·∫ßu ti√™n!</p></div>
  </div>
</div>

<!-- EXPORT -->
<div class="card">
  <div class="sec-title">üì§ Xu·∫•t file</div>
  <div style="font-size:13px;color:#5a6b7f;margin-bottom:12px">
    Ng√¥n ng·ªØ xu·∫•t hi·ªán t·∫°i: <strong id="expLangLabel" style="color:#c9a84c">Ti·∫øng Vi·ªát üáªüá≥</strong>
  </div>
  <div class="exp-grid">
    <div class="exp-card" onclick="expExcel()"><div class="ei">üìä</div><div class="el">Excel</div><div class="es">.xlsx ¬∑ 24 c·ªôt</div></div>
    <div class="exp-card" onclick="expWord()"><div class="ei">üìÑ</div><div class="el">Word</div><div class="es">.docx ¬∑ M·ªói ng∆∞·ªùi 1 trang</div></div>
    <div class="exp-card" onclick="expPDF()"><div class="ei">üî¥</div><div class="el">PDF</div><div class="es">.pdf ¬∑ H·ªì s∆° ƒë·∫ßy ƒë·ªß</div></div>
    <div class="exp-card" onclick="expJSON()"><div class="ei">üíæ</div><div class="el">Backup JSON</div><div class="es">.json ¬∑ L∆∞u d·ªØ li·ªáu</div></div>
  </div>
  <div class="status" id="expStatus" style="margin-top:12px">‚ÑπÔ∏è Ch·ªçn ƒë·ªãnh d·∫°ng ƒë·ªÉ xu·∫•t.</div>
</div>

</div><!-- .app -->
<div class="toast-wrap" id="toastWrap"></div>
<script>
"use strict";

/* ============================================================
   TELEX ENGINE
   ============================================================ */
const TELEX_VOWELS={'a':'a','e':'e','i':'i','o':'o','u':'u','y':'y','aa':'\u00e2','ee':'\u00ea','oo':'\u00f4','AA':'\u00c2','EE':'\u00ca','OO':'\u00d4','aw':'\u0103','ow':'\u01a1','uw':'\u01b0','w':'\u01b0','AW':'\u0102','OW':'\u01a0','UW':'\u01af','W':'\u01af','dd':'\u0111','DD':'\u0110'};
const TONES={'s':1,'f':2,'r':3,'x':4,'j':5};
const TONE_MAP={'a':['a','\u00e1','\u00e0','\u1ea3','\u00e3','\u1ea1'],'\u00e2':['\u00e2','\u1ea5','\u1ea7','\u1ea9','\u1eab','\u1ead'],'\u0103':['\u0103','\u1eaf','\u1eb1','\u1eb3','\u1eb5','\u1eb7'],'e':['e','\u00e9','\u00e8','\u1ebb','\u1ebd','\u1eb9'],'\u00ea':['\u00ea','\u1ebf','\u1ec1','\u1ec3','\u1ec5','\u1ec7'],'i':['i','\u00ed','\u00ec','\u1ec9','\u0129','\u1ecb'],'o':['o','\u00f3','\u00f2','\u1ecf','\u00f5','\u1ecd'],'\u00f4':['\u00f4','\u1ed1','\u1ed3','\u1ed5','\u1ed7','\u1ed9'],'\u01a1':['\u01a1','\u1edb','\u1edd','\u1edf','\u1ee1','\u1ee3'],'u':['u','\u00fa','\u00f9','\u1ee7','\u0169','\u1ee5'],'\u01b0':['\u01b0','\u1ee9','\u1eeb','\u1eed','\u1eef','\u1ef1'],'y':['y','\u00fd','\u1ef3','\u1ef7','\u1ef9','\u1ef5'],'A':['A','\u00c1','\u00c0','\u1ea2','\u00c3','\u1ea0'],'\u00c2':['\u00c2','\u1ea4','\u1ea6','\u1ea8','\u1eaa','\u1eac'],'\u0102':['\u0102','\u1eae','\u1eb0','\u1eb2','\u1eb4','\u1eb6'],'E':['E','\u00c9','\u00c8','\u1eba','\u1ebc','\u1eb8'],'\u00ca':['\u00ca','\u1ebe','\u1ec0','\u1ec2','\u1ec4','\u1ec6'],'I':['I','\u00cd','\u00cc','\u1ec8','\u0128','\u1eca'],'O':['O','\u00d3','\u00d2','\u1ece','\u00d5','\u1ecc'],'\u00d4':['\u00d4','\u1ed0','\u1ed2','\u1ed4','\u1ed6','\u1ed8'],'\u01a0':['\u01a0','\u1eda','\u1edc','\u1ede','\u1ee0','\u1ee2'],'U':['U','\u00da','\u00d9','\u1ee6','\u0168','\u1ee4'],'\u01af':['\u01af','\u1ee8','\u1eea','\u1eec','\u1eee','\u1ef0'],'Y':['Y','\u00dd','\u1ef2','\u1ef6','\u1ef8','\u1ef4']};
function getBaseVowel(ch){for(const[b,a]of Object.entries(TONE_MAP)){if(a.includes(ch))return b;}return ch;}
function getCurrentTone(ch){for(const a of Object.values(TONE_MAP)){const i=a.indexOf(ch);if(i!==-1)return i;}return 0;}
class TelexEngine{constructor(el){this.el=el;this.buf='';el.addEventListener('keydown',e=>this.onKeyDown(e));el.addEventListener('blur',()=>{this.buf='';});el.addEventListener('input',()=>{if(!this._typing)this.buf='';this._typing=false;});}
onKeyDown(e){if(e.ctrlKey||e.metaKey||e.altKey)return;if(e.key.length!==1){this.buf='';return;}const ch=e.key;const el=this.el;const start=el.selectionStart,end=el.selectionEnd;if(start!==end){this.buf='';return;}const val=el.value;const before=val.slice(0,start);const after=val.slice(end);const result=this.applyTelex(before,ch);if(result!==null){e.preventDefault();this._typing=true;el.value=result.text+after;const pos=result.text.length;el.setSelectionRange(pos,pos);el.dispatchEvent(new Event('input',{bubbles:true}));this.buf=result.buf;if(el.id==='fullName')splitName(el.value);}else{this.buf='';}}
applyTelex(before,ch){const lch=ch.toLowerCase();const lastChar=before.length>0?before[before.length-1]:'';const lastBase=getBaseVowel(lastChar);const lastLow=lastBase.toLowerCase();if(lch==='d'){if(lastChar==='d')return{text:before.slice(0,-1)+'\u0111',buf:''};if(lastChar==='D')return{text:before.slice(0,-1)+'\u0110',buf:''};return null;}if(lch in TONES){const toneIdx=TONES[lch];const pos=this.findVowelPos(before);if(pos!==-1){const vowelChar=before[pos];const baseV=getBaseVowel(vowelChar);const curTone=getCurrentTone(vowelChar);if(TONE_MAP[baseV]){let newChar;if(curTone===toneIdx){newChar=TONE_MAP[baseV][0];}else{newChar=TONE_MAP[baseV][toneIdx]||vowelChar;}return{text:before.slice(0,pos)+newChar+before.slice(pos+1),buf:''};}}return null;}if(['a','e','o'].includes(lch)){if(lastLow===lch&&lastBase===lastChar.toLowerCase()){const capKey=lch==='a'?'aa':lch==='e'?'ee':'oo';const UCkey=capKey.toUpperCase();const mapped=lastChar===lastChar.toLowerCase()?TELEX_VOWELS[capKey]:TELEX_VOWELS[UCkey];if(mapped)return{text:before.slice(0,-1)+mapped,buf:''};}}if(lch==='w'){if(lastLow==='u'){const mapped=lastChar==='u'?'\u01b0':'\u01af';return{text:before.slice(0,-1)+mapped,buf:''};}else if(lastLow==='o'){const mapped=lastChar==='o'?'\u01a1':'\u01a0';return{text:before.slice(0,-1)+mapped,buf:''};}else if(lastLow==='a'){const mapped=lastChar==='a'?'\u0103':'\u0102';return{text:before.slice(0,-1)+mapped,buf:''};} else{return{text:before+'\u01b0',buf:''};}}return null;}
findVowelPos(str){const vowels='a\u0103\u00e2e\u00eaio\u00f4\u01a1u\u01b0yA\u0102\u00c2E\u00caIO\u00d4\u01a0U\u01afY\u00e0\u00e1\u1ea3\u00e3\u1ea1\u1ea7\u1ea5\u1ea9\u1eab\u1ead\u1eb1\u1eaf\u1eb3\u1eb5\u1eb7\u00e8\u00e9\u1ebb\u1ebd\u1eb9\u1ec1\u1ebf\u1ec3\u1ec5\u1ec7\u00ec\u00ed\u1ec9\u0129\u1ecb\u00f2\u00f3\u1ecf\u00f5\u1ecd\u1ed3\u1ed1\u1ed5\u1ed7\u1ed9\u1edd\u1edb\u1edf\u1ee1\u1ee3\u00f9\u00fa\u1ee7\u0169\u1ee5\u1eeb\u1ee9\u1eed\u1eef\u1ef1\u1ef3\u00fd\u1ef7\u1ef9\u1ef5';for(let i=str.length-1;i>=Math.max(0,str.length-5);i--){if(vowels.includes(str[i]))return i;}return -1;}}
function initTelex(){document.querySelectorAll('input[type=text],input[type=tel],textarea').forEach(el=>{if(el.id==='cccd')return;new TelexEngine(el);});}

/* ============================================================
   DATA & STATE
   ============================================================ */
let people=[], stt=1, lang='vi';
let recObj=null, isRec=false;

const COL_VI=['stt','H·ªç','T√™n','ng√†y th√°ng nƒÉm sinh','n∆°i sinh','n∆∞·ªõc sinh','Gi·ªõi t√≠nh','t√¨nh tr·∫°ng h√¥n nh√¢n','ID','S·ªë h·ªô chi·∫øu','Ng√†y c·∫•p','Ng√†y h·∫øt h·∫°n','ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫','email','ƒêi·ªán tho·∫°i','Ch·ª©c v·ª•','T√™n c√¥ng ty','S·ªë ƒëi·ªán tho·∫°i c√¥ng ty','ƒê·ªãa ch·ªâ c√¥ng ty','ƒê√£ t·ª´ng ƒëi ch√¢u √¢u ch∆∞a?','Ng√†y c·∫•p visa','ng√†y h·∫øt h·∫°n visa','ng∆∞·ªùi chi tr·∫£','Ng∆∞·ªùi b·∫£o tr·ª£'];
const COL_EN=['No.','Last Name','First Name','Date of Birth','Place of Birth','Country of Birth','Gender','Marital Status','ID Number','Passport Number','Issue Date','Expiry Date','Permanent Address','Email','Phone','Occupation','Company Name','Company Phone','Company Address','Previously visited Europe?','Visa Issue Date','Visa Expiry Date','Sponsor','Guarantor'];
const TRANS={'Nam':'Male','N·ªØ':'Female','Kh√°c':'Other','ƒê·ªôc th√¢n':'Single','ƒê√£ k·∫øt h√¥n':'Married','Ly h√¥n':'Divorced','G√≥a':'Widowed','Ch∆∞a':'No','R·ªìi':'Yes','Vi·ªát Nam':'Vietnam'};

/* ============================================================
   TABS & LANG
   ============================================================ */
function swTab(name,btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tc').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
}
function setLang(l){
  lang=l;
  document.getElementById('langVI').classList.toggle('active',l==='vi');
  document.getElementById('langEN').classList.toggle('active',l==='en');
  const label=document.getElementById('expLangLabel');
  label.textContent=l==='vi'?'Ti·∫øng Vi·ªát üáªüá≥':'English üá∫üá∏';
  toast(l==='vi'?'üáªüá≥ Xu·∫•t Ti·∫øng Vi·ªát':'üá∫üá∏ Export in English','ok');
}

/* ============================================================
   NAME SPLIT
   ============================================================ */
function splitName(v){
  const p=v.trim().split(/\s+/);
  document.getElementById('ho').value=p.length>=2?p[0]:v;
  document.getElementById('ten').value=p.length>=2?p.slice(1).join(' '):'';
}

/* ============================================================
   VALIDATION
   ============================================================ */
function valCCCD(el){const v=el.value.replace(/\D/g,'');el.value=v;const e=document.getElementById('e-cccd');if(v&&v.length!==9&&v.length!==12){el.classList.add('input-err');e.textContent='Ph·∫£i 9 ho·∫∑c 12 s·ªë';}else{el.classList.remove('input-err');e.textContent='';}}
function valPassport(el){const e=document.getElementById('e-hoChieu');if(el.value&&!/^[A-Z]{1,2}\d{6,8}$/i.test(el.value.trim())){el.classList.add('input-err');e.textContent='VD: B1234567';}else{el.classList.remove('input-err');e.textContent='';}}
function valEmail(el){const e=document.getElementById('e-email');if(el.value&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(el.value)){el.classList.add('input-err');e.textContent='Email kh√¥ng h·ª£p l·ªá';}else{el.classList.remove('input-err');e.textContent='';}}

/* ============================================================
   FORM OPERATIONS
   ============================================================ */
function clrForm(){
  document.getElementById('mainForm').reset();
  ['fullName','ho','ten'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('nuocSinh').value='Vi·ªát Nam';
  document.getElementById('didiCA').value='Ch∆∞a';
  document.querySelectorAll('.input-err').forEach(el=>el.classList.remove('input-err'));
  document.querySelectorAll('.err-msg').forEach(el=>el.textContent='');
}
function getForm(){
  let ho=document.getElementById('ho').value.trim();
  let ten=document.getElementById('ten').value.trim();
  const fn=document.getElementById('fullName').value.trim();
  if(!ho&&fn){const p=fn.split(/\s+/);ho=p[0];ten=p.slice(1).join(' ');}
  return{stt,ho,ten,
    ngaySinh:document.getElementById('ngaySinh').value,
    noiSinh:document.getElementById('noiSinh').value.trim(),
    nuocSinh:document.getElementById('nuocSinh').value.trim()||'Vi·ªát Nam',
    gioiTinh:document.getElementById('gioiTinh').value,
    honNhan:document.getElementById('honNhan').value,
    cccd:document.getElementById('cccd').value.trim(),
    hoChieu:document.getElementById('hoChieu').value.trim(),
    ngayCap:document.getElementById('ngayCap').value,
    ngayHetHan:document.getElementById('ngayHetHan').value,
    diaChi:document.getElementById('diaChi').value.trim(),
    email:document.getElementById('email').value.trim(),
    dienThoai:document.getElementById('dienThoai').value.trim(),
    chucVu:document.getElementById('chucVu').value.trim(),
    tenCty:document.getElementById('tenCty').value.trim(),
    dtCty:document.getElementById('dtCty').value.trim(),
    dcCty:document.getElementById('dcCty').value.trim(),
    didiCA:document.getElementById('didiCA').value,
    ngayCapVisa:document.getElementById('ngayCapVisa').value,
    ngayHHVisa:document.getElementById('ngayHHVisa').value,
    nguoiCT:document.getElementById('nguoiCT').value.trim(),
    nguoiBT:document.getElementById('nguoiBT').value.trim()};
}
function addPerson(){
  const d=getForm();
  if(!d.ho&&!d.ten){document.getElementById('e-fullName').textContent='Vui l√≤ng nh·∫≠p h·ªç t√™n!';toast('‚ö†Ô∏è Nh·∫≠p h·ªç t√™n!','err');return;}
  document.getElementById('e-fullName').textContent='';
  people.push(d);stt++;render();clrForm();saveData();
  toast('‚úÖ ƒê√£ th√™m: '+[d.ho,d.ten].filter(Boolean).join(' '),'ok');
}
function delPerson(i){people.splice(i,1);people.forEach((p,idx)=>p.stt=idx+1);stt=people.length+1;render();saveData();toast('üóëÔ∏è ƒê√£ x√≥a','err');}
function clrAll(){if(!confirm('X√≥a to√†n b·ªô danh s√°ch?'))return;people=[];stt=1;render();saveData();toast('üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£','err');}

/* ============================================================
   RENDER TABLE
   ============================================================ */
function render(){
  document.getElementById('totCnt').textContent=people.length;
  const w=document.getElementById('tblWrap');
  if(!people.length){w.innerHTML='<div class="empty"><div class="ei">üìÇ</div><p>Ch∆∞a c√≥ h·ªì s∆° n√†o!</p></div>';return;}
  const heads=['STT','H·ªç','T√™n','Ng√†y sinh','CCCD','H·ªô chi·∫øu','Email','ƒêT','Ch·ª©c v·ª•','X√≥a'];
  let h='<table class="ptbl"><thead><tr>'+heads.map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
  people.forEach((p,i)=>{h+=`<tr><td>${p.stt}</td><td>${esc(p.ho)}</td><td>${esc(p.ten)}</td><td>${fmtD(p.ngaySinh)}</td><td>${esc(p.cccd)||'‚Äî'}</td><td>${esc(p.hoChieu)||'‚Äî'}</td><td>${esc(p.email)||'‚Äî'}</td><td>${esc(p.dienThoai)||'‚Äî'}</td><td>${esc(p.chucVu)||'‚Äî'}</td><td><button class="btn btn-d" onclick="delPerson(${i})">üóëÔ∏è</button></td></tr>`;});
  w.innerHTML=h+'</tbody></table>';
}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function fmtD(s,en){if(!s)return'';try{const d=new Date(s);return isNaN(d)?s:(en?d.toLocaleDateString('en-GB'):d.toLocaleDateString('vi-VN'));}catch{return s;}}
function noTone(s){if(!s)return'';return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\u0111/g,'d').replace(/\u0110/g,'D');}
function buildRow(p){const en=(lang==='en');const nm=en?noTone:x=>x;const fd=s=>fmtD(s,en);const tr=v=>en?(TRANS[v]||v):v;return[p.stt,nm(p.ho),nm(p.ten),fd(p.ngaySinh),nm(p.noiSinh),nm(p.nuocSinh),tr(p.gioiTinh),tr(p.honNhan),p.cccd,p.hoChieu,fd(p.ngayCap),fd(p.ngayHetHan),nm(p.diaChi),p.email,p.dienThoai,nm(p.chucVu),nm(p.tenCty),p.dtCty,nm(p.dcCty),tr(p.didiCA),fd(p.ngayCapVisa),fd(p.ngayHHVisa),nm(p.nguoiCT),nm(p.nguoiBT)];}

/* ============================================================
   TOAST & STATUS HELPERS
   ============================================================ */
function toast(msg,type){const w=document.getElementById('toastWrap');const t=document.createElement('div');t.className='toast'+(type==='err'?' err':type==='ok'?' ok':'');t.textContent=msg;w.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(()=>t.remove(),300);},3000);}
function setSt(id,html,type){const el=document.getElementById(id);el.className='status'+(type?' '+type:'');el.innerHTML=html;}
function setExpSt(msg,type){const el=document.getElementById('expStatus');el.className='status'+(type?' '+type:'');el.innerHTML=msg;}
function dlBlob(blob,name){const u=URL.createObjectURL(blob),a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u);}

/* ============================================================
   EXPORT EXCEL
   ============================================================ */
function expExcel(){
  if(!people.length){toast('‚ö†Ô∏è Danh s√°ch tr·ªëng!','err');return;}
  const en=(lang==='en');
  const ws=XLSX.utils.aoa_to_sheet([en?COL_EN:COL_VI,...people.map(buildRow)]);
  const colW=[5,12,20,15,15,12,10,14,14,14,12,12,30,25,14,18,25,14,30,15,13,13,20,20];
  ws['!cols']=colW.map(w=>({wch:w}));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,en?'Visa Records':'Danh sach ho so');
  XLSX.writeFile(wb,en?'visa_records.xlsx':'ho_so_visa.xlsx');
  setExpSt('‚úÖ Xu·∫•t Excel th√†nh c√¥ng!','ok');toast('‚úÖ ƒê√£ xu·∫•t Excel '+people.length+' h·ªì s∆°!','ok');
}

/* ============================================================
   EXPORT WORD
   ============================================================ */
async function expWord(){
  if(!people.length){toast('‚ö†Ô∏è Danh s√°ch tr·ªëng!','err');return;}
  setExpSt('<div class="spin"></div> ƒêang t·∫°o Word...','run');
  try{
    const{Document,Packer,Paragraph,TextRun,HeadingLevel,AlignmentType,Table,TableRow,TableCell,WidthType}=docx;
    const en=(lang==='en');const nm=en?noTone:x=>x;const fd=s=>fmtD(s,en);const tr=v=>en?(TRANS[v]||v):v;
    const allCh=[];
    people.forEach((p,idx)=>{
      const title=en?'VISA APPLICATION FORM':'PHIEU KHAI THONG TIN XIN VISA CHAU AU';
      const labels=en?[['Full Name',nm(p.ho+' '+p.ten)],['Last Name',nm(p.ho)],['First Name',nm(p.ten)],['Date of Birth',fd(p.ngaySinh)],['Place of Birth',nm(p.noiSinh)],['Country of Birth',nm(p.nuocSinh)],['Gender',tr(p.gioiTinh)],['Marital Status',tr(p.honNhan)],['ID Number',p.cccd],['Passport Number',p.hoChieu],['Issue Date',fd(p.ngayCap)],['Expiry Date',fd(p.ngayHetHan)],['Permanent Address',nm(p.diaChi)],['Email',p.email],['Phone',p.dienThoai],['Occupation',nm(p.chucVu)],['Company Name',nm(p.tenCty)],['Company Phone',p.dtCty],['Company Address',nm(p.dcCty)],['Previously Visited Europe?',tr(p.didiCA)],['Visa Issue Date',fd(p.ngayCapVisa)],['Visa Expiry Date',fd(p.ngayHHVisa)],['Sponsor',nm(p.nguoiCT)],['Guarantor',nm(p.nguoiBT)]]:
      [['Ho va ten',noTone(p.ho+' '+p.ten)],['Ho',noTone(p.ho)],['Ten',noTone(p.ten)],['Ngay thang nam sinh',fd(p.ngaySinh)],['Noi sinh',noTone(p.noiSinh)],['Nuoc sinh',noTone(p.nuocSinh)],['Gioi tinh',p.gioiTinh],['Tinh trang hon nhan',p.honNhan],['CCCD/ID',p.cccd],['So ho chieu',p.hoChieu],['Ngay cap ho chieu',fd(p.ngayCap)],['Ngay het han ho chieu',fd(p.ngayHetHan)],['Dia chi thuong tru',noTone(p.diaChi)],['Email',p.email],['Dien thoai',p.dienThoai],['Chuc vu',noTone(p.chucVu)],['Ten cong ty',noTone(p.tenCty)],['SDT cong ty',p.dtCty],['Dia chi cong ty',noTone(p.dcCty)],['Da tung di chau Au?',p.didiCA],['Ngay cap visa',fd(p.ngayCapVisa)],['Ngay het han visa',fd(p.ngayHHVisa)],['Nguoi chi tra',noTone(p.nguoiCT)],['Nguoi bao tro',noTone(p.nguoiBT)]];
      const tblRows=labels.map(([lb,vl])=>new TableRow({children:[new TableCell({width:{size:38,type:WidthType.PERCENTAGE},children:[new Paragraph({children:[new TextRun({text:lb,bold:true})],spacing:{after:60}})],margins:{top:80,bottom:80,left:120,right:80}}),new TableCell({width:{size:62,type:WidthType.PERCENTAGE},children:[new Paragraph({children:[new TextRun({text:vl||'‚Äî'})],spacing:{after:60}})],margins:{top:80,bottom:80,left:120,right:80}})]}));
      allCh.push(new Paragraph({text:title,heading:HeadingLevel.HEADING_1,alignment:AlignmentType.CENTER,spacing:{after:200}}),new Paragraph({children:[new TextRun({text:en?`Applicant No. ${p.stt}`:`Ho so so: ${p.stt}`,bold:true,size:26})],alignment:AlignmentType.CENTER,spacing:{after:400}}),new Table({width:{size:100,type:WidthType.PERCENTAGE},rows:tblRows}),new Paragraph({spacing:{after:400}}),new Paragraph({children:[new TextRun({text:en?'Signature: _______________________':'Chu ky: _______________________',italics:true})],alignment:AlignmentType.RIGHT}),new Paragraph({children:[new TextRun({text:en?`Date: ${new Date().toLocaleDateString('en-GB')}`:`Ngay: ${new Date().toLocaleDateString('vi-VN')}`,italics:true})],alignment:AlignmentType.RIGHT,spacing:{after:200}}));
      if(idx<people.length-1)allCh.push(new Paragraph({pageBreakBefore:true}));
    });
    const doc=new Document({sections:[{properties:{},children:allCh}]});
    const blob=await Packer.toBlob(doc);
    dlBlob(blob,en?'visa_applications.docx':'ho_so_visa.docx');
    setExpSt('‚úÖ Xu·∫•t Word th√†nh c√¥ng!','ok');toast('‚úÖ ƒê√£ xu·∫•t Word '+people.length+' h·ªì s∆°!','ok');
  }catch(e){console.error(e);setExpSt('‚ùå L·ªói Word: '+e.message,'err');toast('‚ùå L·ªói Word: '+e.message,'err');}
}

/* ============================================================
   EXPORT PDF
   ============================================================ */
function expPDF(){
  if(!people.length){toast('‚ö†Ô∏è Danh s√°ch tr·ªëng!','err');return;}
  setExpSt('<div class="spin"></div> ƒêang t·∫°o PDF...','run');
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const en=(lang==='en');const fd=s=>fmtD(s,en);const tr=v=>en?(TRANS[v]||v):v;
  const W=doc.internal.pageSize.getWidth(),H=doc.internal.pageSize.getHeight(),M=18,LH=7;
  doc.setFont('helvetica');
  people.forEach((p,idx)=>{
    if(idx>0)doc.addPage();let y=M;
    doc.setFillColor(13,27,46);doc.rect(0,0,W,28,'F');
    doc.setTextColor(201,168,76);doc.setFontSize(14);doc.setFont('helvetica','bold');
    doc.text(en?'VISA APPLICATION FORM':'PHIEU KHAI THONG TIN XIN VISA',W/2,11,{align:'center'});
    doc.setFontSize(10);doc.setTextColor(200,200,200);
    doc.text(en?`Applicant No. ${p.stt}`:`Ho so so: ${p.stt}`,W/2,20,{align:'center'});
    y=34;doc.setDrawColor(201,168,76);doc.setLineWidth(0.6);doc.line(M,y,W-M,y);y+=7;
    const fields=en?[['Full Name',noTone(p.ho+' '+p.ten)],['Last Name',noTone(p.ho)],['First Name',noTone(p.ten)],['Date of Birth',fd(p.ngaySinh)],['Place of Birth',noTone(p.noiSinh)],['Country of Birth',noTone(p.nuocSinh)],['Gender',tr(p.gioiTinh)],['Marital Status',tr(p.honNhan)],['ID Number',p.cccd],['Passport Number',p.hoChieu],['Issue Date',fd(p.ngayCap)],['Expiry Date',fd(p.ngayHetHan)],['Address',noTone(p.diaChi)],['Email',p.email],['Phone',p.dienThoai],['Occupation',noTone(p.chucVu)],['Company',noTone(p.tenCty)],['Company Phone',p.dtCty],['Company Address',noTone(p.dcCty)],['Visited Europe?',tr(p.didiCA)],['Visa Issue Date',fd(p.ngayCapVisa)],['Visa Expiry Date',fd(p.ngayHHVisa)],['Sponsor',noTone(p.nguoiCT)],['Guarantor',noTone(p.nguoiBT)]]:
    [['Ho va ten',noTone(p.ho+' '+p.ten)],['Ho',noTone(p.ho)],['Ten',noTone(p.ten)],['Ngay sinh',fd(p.ngaySinh)],['Noi sinh',noTone(p.noiSinh)],['Nuoc sinh',noTone(p.nuocSinh)],['Gioi tinh',p.gioiTinh],['Hon nhan',p.honNhan],['CCCD/ID',p.cccd],['Ho chieu',p.hoChieu],['Ngay cap',fd(p.ngayCap)],['Het han HC',fd(p.ngayHetHan)],['Dia chi',noTone(p.diaChi)],['Email',p.email],['Dien thoai',p.dienThoai],['Chuc vu',noTone(p.chucVu)],['Cong ty',noTone(p.tenCty)],['DT cong ty',p.dtCty],['DC cong ty',noTone(p.dcCty)],['Da di Chau Au?',p.didiCA],['Ngay cap visa',fd(p.ngayCapVisa)],['Het han visa',fd(p.ngayHHVisa)],['Nguoi chi tra',noTone(p.nguoiCT)],['Nguoi bao tro',noTone(p.nguoiBT)]];
    const c2X=M+58,maxW=W-c2X-M;
    fields.forEach(([lb,vl],fi)=>{if(y>H-28){doc.addPage();y=M+6;}if(fi%2===0){doc.setFillColor(248,242,228);doc.rect(M,y-4,W-M*2,LH+1,'F');}doc.setTextColor(10,22,40);doc.setFontSize(8.5);doc.setFont('helvetica','bold');doc.text(lb+':',M,y);doc.setFont('helvetica','normal');doc.setTextColor(30,30,60);const lines=doc.splitTextToSize(vl||'‚Äî',maxW);doc.text(lines,c2X,y);y+=Math.max(LH,lines.length*LH);});
    y+=8;if(y>H-36){doc.addPage();y=M+6;}
    doc.setDrawColor(180,180,180);doc.setLineWidth(0.3);doc.line(M,y,W/2+20,y);y+=7;
    doc.setFontSize(8.5);doc.setFont('helvetica','italic');doc.setTextColor(100,100,100);
    doc.text(en?'Signature: _____________________':'Chu ky: _____________________',W-M-72,y);
    doc.text(en?`Date: ${new Date().toLocaleDateString('en-GB')}`:`Ngay: ${new Date().toLocaleDateString('vi-VN')}`,W-M-72,y+7);
    doc.setFillColor(13,27,46);doc.rect(0,H-10,W,10,'F');
    doc.setTextColor(130,130,130);doc.setFontSize(7);doc.setFont('helvetica','normal');
    doc.text('Visa Manager PWA | Trang '+(idx+1)+'/'+people.length,W/2,H-4,{align:'center'});
  });
  doc.save(en?'visa_applications.pdf':'ho_so_visa.pdf');
  setExpSt('‚úÖ Xu·∫•t PDF th√†nh c√¥ng!','ok');toast('‚úÖ ƒê√£ xu·∫•t PDF '+people.length+' h·ªì s∆°!','ok');
}

function expJSON(){if(!people.length){toast('‚ö†Ô∏è Danh s√°ch tr·ªëng!','err');return;}dlBlob(new Blob([JSON.stringify(people,null,2)],{type:'application/json'}),'visa_backup_'+Date.now()+'.json');toast('üíæ ƒê√£ l∆∞u backup JSON!','ok');}

/* ============================================================
   üé§ VOICE RECOGNITION  ‚Äì xin quy·ªÅn mic ƒë√∫ng c√°ch
   ============================================================ */
function togVoice(){isRec?stopVoice():startVoice();}

async function startVoice(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){
    setSt('vStatus','‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ghi √¢m. H√£y d√πng Chrome ho·∫∑c Edge!','err');
    toast('‚ùå C·∫ßn Chrome/Edge ƒë·ªÉ ghi √¢m!','err');return;
  }
  // Xin quy·ªÅn microphone t∆∞·ªùng minh
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    stream.getTracks().forEach(t=>t.stop());
    document.getElementById('micNote').classList.remove('show');
  }catch(permErr){
    document.getElementById('micNote').classList.add('show');
    setSt('vStatus','‚ùå Ch∆∞a c√≥ quy·ªÅn Microphone. Xem h∆∞·ªõng d·∫´n ph√≠a tr√™n.','err');
    toast('‚ùå C·∫ßn c·∫•p quy·ªÅn Microphone!','err');return;
  }
  recObj=new SR();recObj.lang='vi-VN';recObj.continuous=true;recObj.interimResults=true;
  let final='';
  recObj.onstart=()=>{
    isRec=true;
    document.getElementById('vBtn').classList.add('recording');
    document.getElementById('vBtnTxt').textContent='‚èπ D·ª´ng ghi √¢m';
    document.getElementById('vwave').classList.add('on');
    setSt('vStatus','<div class="spin"></div> ƒêang ghi √¢m... N√≥i ƒëi!','run');
  };
  recObj.onresult=e=>{
    let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal)final+=e.results[i][0].transcript;
      else interim+=e.results[i][0].transcript;
    }
    document.getElementById('vText').value=final+interim;
  };
  recObj.onerror=e=>{setSt('vStatus','‚ùå L·ªói ghi √¢m: '+e.error,'err');stopVoice();};
  recObj.onend=()=>{if(isRec)recObj.start();};
  recObj.start();
}

function stopVoice(){
  isRec=false;if(recObj)recObj.stop();
  document.getElementById('vBtn').classList.remove('recording');
  document.getElementById('vBtnTxt').textContent='B·∫Øt ƒë·∫ßu ghi √¢m';
  document.getElementById('vwave').classList.remove('on');
  setSt('vStatus','‚úÖ Ghi √¢m xong. Nh·∫•n "Ph√¢n t√≠ch ‚Üí ƒêi·ªÅn form".','ok');
}

function parseVoice(){
  const txt=document.getElementById('vText').value.trim();
  if(!txt){toast('‚ö†Ô∏è Ch∆∞a c√≥ vƒÉn b·∫£n!','err');return;}
  setSt('vStatus','<div class="spin"></div> AI ƒëang ph√¢n t√≠ch...','run');
  setTimeout(()=>{try{fillForm(nlpVi(txt));setSt('vStatus','‚úÖ ƒê√£ ƒëi·ªÅn form t·ª´ AI!','ok');toast('ü§ñ AI ƒë√£ ƒëi·ªÅn form!','ok');}catch(e){setSt('vStatus','‚ùå L·ªói: '+e.message,'err');}},700);
}

/* ============================================================
   NLP PARSER (ti·∫øng Vi·ªát)
   ============================================================ */
function nlpVi(txt){
  const r={};
  const nm=txt.match(/(?:h·ªç(?:\s+v√†)?\s+t√™n|t√™n(?:\s+ƒë·∫ßy\s+ƒë·ªß)?|t√™n\s+l√†)\s*(?:l√†\s+)?([A-Z√Ä-·ªπa-z√†-·ªπ][A-Z√Ä-·ªπa-z√†-·ªπ\s]{4,50})(?=[,.\n]|sinh|cccd|sdt|email)/i)||txt.match(/^([A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√ö√ù][a-zA-Z√Ä-·ªπ\s]{4,50})(?=[,\n])/i);
  if(nm)r.fullName=nm[1].trim();
  const dob=txt.match(/sinh\s+(?:ng√†y\s+)?(\d{1,2})[\/\-\s](?:th√°ng\s+)?(\d{1,2})[\/\-\s](?:nƒÉm\s+)?(\d{4})/i)||txt.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
  if(dob)r.ngaySinh=`${dob[3]}-${dob[2].padStart(2,'0')}-${dob[1].padStart(2,'0')}`;
  const ns=txt.match(/(?:qu√™|n∆°i\s+sinh|sinh\s+(?:t·∫°i|·ªü))\s+(?:t·∫°i\s+)?([^,.\n]+)/i);
  if(ns)r.noiSinh=ns[1].trim();
  if(/\bnam\b/i.test(txt))r.gioiTinh='Nam';else if(/\bn·ªØ\b/i.test(txt))r.gioiTinh='N·ªØ';
  if(/ƒë·ªôc\s*th√¢n/i.test(txt))r.honNhan='ƒê·ªôc th√¢n';else if(/k·∫øt\s*h√¥n/i.test(txt))r.honNhan='ƒê√£ k·∫øt h√¥n';else if(/ly\s*h√¥n/i.test(txt))r.honNhan='Ly h√¥n';
  const cc=txt.match(/(?:cccd|cƒÉn\s+c∆∞·ªõc|cmnd)\s*(?:s·ªë\s*)?(\d{9}|\d{12})/i)||txt.match(/\b(\d{12})\b/)||txt.match(/\b(\d{9})\b/);
  if(cc)r.cccd=cc[1];
  const hc=txt.match(/(?:h·ªô\s+chi·∫øu|passport)\s*(?:s·ªë\s*)?([A-Z]{1,2}\d{6,8})/i);
  if(hc)r.hoChieu=hc[1].toUpperCase();
  const em=txt.match(/([a-zA-Z0-9._+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,})/);
  if(em)r.email=em[1];
  const dt=txt.match(/\b(0[3-9]\d{8})\b/);
  if(dt)r.dienThoai=dt[1];
  const dc=txt.match(/(?:ƒë·ªãa\s+ch·ªâ|th∆∞·ªùng\s+tr√∫|s·ªëng\s+(?:t·∫°i|·ªü))\s+(?:t·∫°i\s+)?([^.\n]+)/i);
  if(dc)r.diaChi=dc[1].trim();
  const cv=txt.match(/(?:ch·ª©c\s+v·ª•|ngh·ªÅ|c√¥ng\s+vi·ªác)\s+(?:l√†\s+)?([^,.\n]+)/i);
  if(cv)r.chucVu=cv[1].trim();
  const ct=txt.match(/(?:c√¥ng\s+ty|cty)\s+([^,.\n]+)/i);
  if(ct)r.tenCty=ct[1].trim();
  r.didiCA=/ƒëi\s+ch√¢u\s+√¢u/i.test(txt)?'R·ªìi':'Ch∆∞a';
  r.nuocSinh='Vi·ªát Nam';
  return r;
}

function fillForm(d){
  const set=(id,v)=>{if(v!=null&&v!==''&&document.getElementById(id))document.getElementById(id).value=v;};
  if(d.fullName){set('fullName',d.fullName);splitName(d.fullName);}
  set('ngaySinh',d.ngaySinh);set('noiSinh',d.noiSinh);set('nuocSinh',d.nuocSinh||'Vi·ªát Nam');
  if(d.gioiTinh){const el=document.getElementById('gioiTinh');if(el)el.value=d.gioiTinh;}
  if(d.honNhan){const el=document.getElementById('honNhan');if(el)el.value=d.honNhan;}
  set('cccd',d.cccd);set('hoChieu',d.hoChieu);
  set('ngayCap',d.ngayCap);set('ngayHetHan',d.ngayHetHan);
  set('diaChi',d.diaChi);set('email',d.email);set('dienThoai',d.dienThoai);
  set('chucVu',d.chucVu);set('tenCty',d.tenCty);set('dtCty',d.dtCty);set('dcCty',d.dcCty);
  if(d.didiCA){const el=document.getElementById('didiCA');if(el)el.value=d.didiCA;}
  set('ngayCapVisa',d.ngayCapVisa);set('ngayHHVisa',d.ngayHHVisa);
  set('nguoiCT',d.nguoiCT);set('nguoiBT',d.nguoiBT);
}

/* ============================================================
   üì∑ OCR ‚Äì camera vs gallery ri√™ng, fix mobile
   ============================================================ */
function openCamera(){document.getElementById('ocrCamera').value='';document.getElementById('ocrCamera').click();}
function openGallery(){document.getElementById('ocrGallery').value='';document.getElementById('ocrGallery').click();}

function preprocessImage(file){
  return new Promise(resolve=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const scale=Math.max(1,1600/img.width);
        const canvas=document.createElement('canvas');
        canvas.width=img.width*scale;canvas.height=img.height*scale;
        const ctx=canvas.getContext('2d');
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        const id=ctx.getImageData(0,0,canvas.width,canvas.height);
        const d=id.data;
        let minL=255,maxL=0;
        for(let i=0;i<d.length;i+=4){const l=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];if(l<minL)minL=l;if(l>maxL)maxL=l;}
        const range=maxL-minL||1;
        for(let i=0;i<d.length;i+=4){
          let v=((0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])-minL)/range*255;
          v=255/(1+Math.exp(-0.05*(v-128)));
          v=v<128?Math.max(0,v*0.82):Math.min(255,v*1.12+8);
          d[i]=d[i+1]=d[i+2]=v;
        }
        ctx.putImageData(id,0,0);
        resolve(canvas.toDataURL('image/png',1.0));
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function parseMRZ(text){
  const lines=text.split('\n').map(l=>l.replace(/\s+/g,'').toUpperCase());
  const mrzLines=lines.filter(l=>/^[A-Z0-9<]{30,44}$/.test(l));
  if(mrzLines.length<2)return null;
  let line1='',line2='';
  for(const l of mrzLines){if(l.startsWith('P<')||l.startsWith('P<VNM'))line1=l;else if(/^[A-Z0-9]{1,2}[0-9]{7}/.test(l))line2=l;}
  if(!line1||!line2){const sorted=[...mrzLines].sort((a,b)=>b.length-a.length);for(const l of sorted){if(!line1&&(l.startsWith('P')||l.includes('VNM')))line1=l;else if(!line2)line2=l;}}
  if(!line1||!line2)return null;
  const result={};
  try{
    const doubleLtIdx=line1.indexOf('<<',5);
    if(doubleLtIdx>5){
      const surnPart=line1.slice(5,doubleLtIdx).replace(/</g,' ').trim();
      const givenPart=line1.slice(doubleLtIdx+2).replace(/<+/g,' ').trim();
      result.fullName=(givenPart+' '+surnPart).trim();
    }
    const l2=line2.padEnd(44,'<');
    result.hoChieu=l2.slice(0,9).replace(/</g,'');
    const dobRaw=l2.slice(13,19);
    if(/^\d{6}$/.test(dobRaw)){let yy=parseInt(dobRaw.slice(0,2));const mm=dobRaw.slice(2,4),dd=dobRaw.slice(4,6);result.ngaySinh=`${yy>30?1900+yy:2000+yy}-${mm}-${dd}`;}
    const sex=l2[20];if(sex==='M')result.gioiTinh='Nam';else if(sex==='F')result.gioiTinh='N·ªØ';
    const expRaw=l2.slice(21,27);
    if(/^\d{6}$/.test(expRaw)){let yy=parseInt(expRaw.slice(0,2));const mm=expRaw.slice(2,4),dd=expRaw.slice(4,6);result.ngayHetHan=`${yy<50?2000+yy:1900+yy}-${mm}-${dd}`;}
    result.quocTich='Vi·ªát Nam';result.nuocSinh='Vi·ªát Nam';
  }catch(err){console.warn('MRZ err:',err);}
  return Object.keys(result).length>1?result:null;
}

function nlpPassport(txt){
  const r={};const lines=txt.split('\n').map(l=>l.trim()).filter(l=>l);
  for(let i=0;i<lines.length;i++){const l=lines[i];
    if(/full\s*name|ho\s*va\s*ten|h·ªç\s*v√†\s*t√™n/i.test(l)){const s=l.replace(/full\s*name|ho\s*va\s*ten|h·ªç\s*v√†\s*t√™n/i,'').replace(/[:\-\/]/g,'').trim();if(s.length>3)r.fullName=s;else if(i+1<lines.length&&/^[A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√ö√ù\s]{5,}$/.test(lines[i+1]))r.fullName=lines[i+1].trim();}
    if(!r.fullName&&/^[A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√ö√ù][A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√ö√ù\s]{9,49}$/.test(l)&&!/SOCIALIST|REPUBLIC|VIETNAM|CHI·∫æU|PASSPORT|NATIONALITY|DATE|BIRTH|PLACE|ISSUE|EXPIRY|SEX|GI·ªöI|NG√ÄY|N∆†I|C·∫§P/i.test(l)&&!/[<]/.test(l))r.fullName=l.trim();
  }
  const hcMatch=txt.match(/\b([A-Z][0-9]{7,8})\b/);if(hcMatch)r.hoChieu=hcMatch[1];
  const dobPats=[/(?:date\s*of\s*birth|ng√†y\s*sinh)\s*[:\-\/]?\s*(\d{1,2})\s*[\/\-\.\s]\s*(\d{1,2})\s*[\/\-\.\s]\s*(\d{4})/i,/(\d{2})\s*\/\s*(\d{2})\s*\/\s*(\d{4})/,/(\d{2})\s*\.\s*(\d{2})\s*\.\s*(\d{4})/];
  for(const p of dobPats){const m=txt.match(p);if(m){r.ngaySinh=`${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;break;}}
  const nb=txt.match(/(?:place\s*of\s*birth|n∆°i\s*sinh)\s*[:\-\/]?\s*([A-Z√Ä-·ªπa-z√†-·ªπ\.\s]{3,40})/i);if(nb)r.noiSinh=nb[1].trim();
  if(/\bNAM\b|\bMALE\b|\bNAM\s*\/\s*M\b/i.test(txt))r.gioiTinh='Nam';else if(/\bN·ªÆ\b|\bFEMALE\b/i.test(txt))r.gioiTinh='N·ªØ';
  const nc=txt.match(/(?:date\s*of\s*issue|ng√†y\s*c·∫•p)\s*[:\-\/]?\s*(\d{1,2})\s*[\/\-\.\s]\s*(\d{1,2})\s*[\/\-\.\s]\s*(\d{4})/i);if(nc)r.ngayCap=`${nc[3]}-${nc[2].padStart(2,'0')}-${nc[1].padStart(2,'0')}`;
  const nh=txt.match(/(?:expir|h·∫øt\s*h·∫°n|c√≥\s*gi√°\s*tr·ªã)\s*[:\-\/]?\s*(\d{1,2})\s*[\/\-\.\s]\s*(\d{1,2})\s*[\/\-\.\s]\s*(\d{4})/i);if(nh)r.ngayHetHan=`${nh[3]}-${nh[2].padStart(2,'0')}-${nh[1].padStart(2,'0')}`;
  r.nuocSinh='Vi·ªát Nam';return r;
}

async function handleOCRFile(file){
  if(!file)return;
  const imgEl=document.getElementById('ocrImg');
  imgEl.src=URL.createObjectURL(file);imgEl.style.display='block';
  const bar=document.getElementById('ocrBar'),fill=document.getElementById('ocrFill');
  bar.style.display='block';fill.style.width='5%';
  setSt('ocrStatus','<div class="spin"></div> ƒêang ti·ªÅn x·ª≠ l√Ω ·∫£nh...','run');
  try{
    const processed=await preprocessImage(file);
    fill.style.width='20%';
    setSt('ocrStatus','<div class="spin"></div> Tesseract ƒëang nh·∫≠n di·ªán...','run');
    const worker=await Tesseract.createWorker(['vie','eng'],1,{logger:m=>{if(m.status==='recognizing text'){const pct=20+Math.round(m.progress*75);fill.style.width=pct+'%';setSt('ocrStatus','<div class="spin"></div> Nh·∫≠n di·ªán: '+pct+'%','run');}}});
    await worker.setParameters({tessedit_pageseg_mode:'1',preserve_interword_spaces:'1'});
    const{data:{text}}=await worker.recognize(processed);
    await worker.terminate();
    fill.style.width='100%';
    const mrzData=parseMRZ(text);
    const nlpData=nlpPassport(text);
    const finalData=Object.assign({},nlpData,mrzData);
    document.getElementById('vText').value=text;
    swTab('voice',document.querySelector('.tab-btn'));
    fillForm(finalData);
    const mrzMsg=mrzData?' (MRZ ‚úì)':'';
    setSt('ocrStatus','‚úÖ Nh·∫≠n di·ªán xong'+mrzMsg+'! Ki·ªÉm tra l·∫°i form.','ok');
    toast('üîç OCR th√†nh c√¥ng'+mrzMsg+'!','ok');
  }catch(e){
    setSt('ocrStatus','‚ùå OCR l·ªói: '+e.message,'err');
    toast('‚ùå OCR l·ªói: '+e.message,'err');
    console.error(e);
  }
}

/* ============================================================
   LOCAL STORAGE
   ============================================================ */
function saveData(){try{localStorage.setItem('visaPeople',JSON.stringify(people));}catch(e){}}
function loadData(){try{const d=localStorage.getItem('visaPeople');if(d){people=JSON.parse(d);stt=people.length+1;}}catch(e){}}

/* ============================================================
   INIT
   ============================================================ */
window.onload=()=>{
  loadData();render();initTelex();
  const fnInput=document.getElementById('fullName');
  fnInput.addEventListener('input',()=>splitName(fnInput.value));
  toast('üõÇ Visa Manager s·∫µn s√†ng!','ok');
};
</script>

<!-- PWA INSTALL BANNER -->
<div id="pwaInstall" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:9998;background:#0d1b2e;border-top:2px solid #c9a84c;padding:12px 16px;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;padding-bottom:calc(12px + env(safe-area-inset-bottom))">
  <div style="display:flex;align-items:center;gap:10px">
    <img src="icons/icon-72.png" style="width:38px;height:38px;border-radius:8px">
    <div><div style="color:#c9a84c;font-weight:700;font-size:14px;font-family:Arial">C√†i ·ª©ng d·ª•ng Visa Manager</div><div style="color:#aaa;font-size:12px;font-family:Arial">D√πng offline ¬∑ Kh√¥ng c·∫ßn tr√¨nh duy·ªát</div></div>
  </div>
  <div style="display:flex;gap:8px">
    <button onclick="document.getElementById('pwaInstall').style.display='none'" style="padding:8px 14px;border-radius:6px;border:1px solid #555;background:transparent;color:#aaa;cursor:pointer;font-family:Arial;font-size:13px">B·ªè qua</button>
    <button id="pwaInstallBtn" style="padding:8px 18px;border-radius:6px;border:none;background:#c9a84c;color:#fff;cursor:pointer;font-family:Arial;font-size:13px;font-weight:700">‚¨á C√†i ngay</button>
  </div>
</div>

<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').catch(()=>{});});
}
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredPrompt=e;
  document.getElementById('pwaInstall').style.display='flex';
});
document.getElementById('pwaInstallBtn').addEventListener('click',async()=>{
  if(!deferredPrompt)return;
  deferredPrompt.prompt();
  const{outcome}=await deferredPrompt.userChoice;
  deferredPrompt=null;
  document.getElementById('pwaInstall').style.display='none';
  if(outcome==='accepted')toast('üéâ ƒê√£ c√†i ·ª©ng d·ª•ng!','ok');
});
window.addEventListener('appinstalled',()=>{
  document.getElementById('pwaInstall').style.display='none';
  toast('üéâ Visa Manager ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t!','ok');
});
</script>
</body>
</html>
